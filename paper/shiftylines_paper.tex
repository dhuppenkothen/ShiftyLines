% This document is part of the ShiftyLines project.
% Copyright 2016 the authors.

\documentclass[12pt]{emulateapj}
\usepackage{graphicx}
%\usepackage{epsfig}
\usepackage{times}
\usepackage{natbib}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amsbsy}
\usepackage{bm}
\usepackage{hyperref}
\usepackage{url}
%\usepackage{subfigure}
\usepackage{microtype}
\usepackage{rotating}
\usepackage{booktabs}
\usepackage{threeparttable}
\usepackage{tabularx}
\usepackage{subfigure}


%\usepackage{longtable}%\usepackage[stable]{footmisc}
%\usepackage{color}
%\bibliographystyle{apj}

\newcommand{\project}[1]{\textsl{#1}}
\newcommand{\fermi}{\project{Fermi}}
\newcommand{\rxte}{\project{RXTE}}
\newcommand{\given}{\,|\,}
\newcommand{\dd}{\mathrm{d}}
\newcommand{\counts}{y}
\newcommand{\pars}{\theta}
\newcommand{\mean}{m}
\newcommand{\likelihood}{{\mathcal L}}
\newcommand{\Poisson}{{\mathcal P}}
\newcommand{\Uniform}{{\mathcal U}}
\newcommand{\bg}{\mathrm{bg}}
\newcommand{\word}{\phi}

\DeclareMathOperator\erf{erf}

%\newcommand{\bs}{\boldsymbol}

\begin{document}

\title{Shifty Lines: Probabilistic inference of multiple redshifts from a spectrum}

\author{D. Huppenkothen\altaffilmark{1, 2}, B. J. Brewer\altaffilmark{3}, Victoria Grinberg\altaffilmark{4}}
 
  \altaffiltext{1}{Center for Data Science, New York University, 726 Broadway, 7th Floor, New York, NY 10003}
  \altaffiltext{2}{{\tt daniela.huppenkothen@nyu.edu}}
  \altaffiltext{3}{Department of Statistics, The University of Auckland, Private Bag 92019, Auckland 1142, New Zealand}
  \altaffiltext{4}{MIT Kavli Institute for Astrophysics and Space Research,
MIT, 70 Vassar Street, Cambridge, MA 02139, USA}


\begin{abstract}
Stellar winds and winds from accretion disks have Doppler shifts. Sometimes, there can be more than one Doppler shift in 
the same X-ray spectrum. This project solves the problem where (a) we do not know the line amplitudes and widths, (b) the 
number of Doppler shifts in the system and (c) which line belongs to which Doppler shift.

\end{abstract}

\keywords{methods:statistics}

\section{Introduction}

Accretion disks and winds and stuff.

There are other astrophysical problems where similar questions arise. For
example, many galaxy-galaxy strong gravitational lens systems were
found by the Sloan Lens ACS Survey \citep[SLACS;][]{slacs0, slacs1} by searching
the Sloan Digital Sky Survey for sources whose spectra seemed to contain two
redshifts. Hubble Space Telescope imaging was then used to find the candidates
that were actually gravitational lenses.
The methods used by SLACS to identify two redshifts in a spectrum can be
considered as more heuristic solution to the same problem we consider in this
paper. However, we focus more on the issue of characterizing all of the
uncertainties (i.e. exploring the range of hypotheses plausible given the
spectral data), rather than prioritizing computational speed.

\section{Method}

High-resolution spectral data consists of a continuum with a set of spectral lines superposed. A priori, we (approximately) know the rest frame wavelengths of the most common lines, but neither the amplitudes nor widths of these lines is known, thus they should be part of the inference process. Strictly speaking, because rest frame line positions in the spectrum are based on laboratory measurements, they have an uncertainty associated with them, too, but we currently do not take this uncertainty into account in the model.

 The objective, given a spectrum and a set of rest frame wavelengths of spectral lines, is to infer the amplitudes and widths of all (potential) lines at the same time as the one or several Doppler shifts affecting the centroid wavelengths of the spectral lines. Not all lines may be present in the data, but we consciously avoid performing model selection tasks for each individual line. Instead, we rephrase the problem as a parameter estimation task only, where the absence of a line will lead to a model preferring a very small amplitude for that line. This reflects our state of knowledge of the system: in practice, it is impossible to distinguish between the absence of a line and a line with a very small amplitude.

Each line $k$ is modelled as a Gaussian with location and scale parameters $\mu_k$ and $\sigma_k$ as well as an amplitude $A_k$, respectively. Note that $A_k$ is defined as the integrated flux over the line. We compute the line flux in each wavelength bin $j$ by integrating the model flux within the bin from the lower edge $\lambda_{j, \mathrm{low}}$ to the upper bin edge $\lambda_{j, \mathrm{high}}$:

\begin{eqnarray}
\mean_j & = &  \sum_{k=1}^{K}{\int^{\lambda_{j,\mathrm{high}}}_{\lambda_{j, \mathrm{low}}}{\frac{A_k}{\sigma_k\sqrt{2\pi}} \exp{(-(\lambda-\mu_k)/{2\sigma_k^2})}}} \\ \nonumber
& = & \frac{1}{2}\sum_{k=1}^{K} A_k\left[ \erf{\left( \frac{\lambda_{j,\mathrm{high}} - \mu_k}{\sigma_k\sqrt{2}}\right)} - \erf{\left( \frac{\lambda_{j, \mathrm{low}} - \mu_k}{\sigma_k\sqrt{2}}\right)} \right] \; ,
\end{eqnarray}

\noindent where $j$ is the index of a wavelength bin and $\erf$ defines the error function. 

X-ray spectra have very noticeable continuum contributions as well as calibration that needs to be performed on the data. In most high-resolution spectra, the continuum will be fit separately to the data and then divided out before attempting line fits. In principle, the statistically consistent approach to the model we propose here would be to fit continuum parameters at the same time as the spectral lines. Because both continuum modelling and calibration is a non-trivial task for high-resolution spectroscopy, we do not attempt in this work to include this contribution, but note that there is scope for improvement in this direction in the future. 
Instead, we choose a simple model to account for residual continuum contributions and potential biases due to incorrect calibration by modeling the continuum by a combination of a simple constant model and an autoregressive process called an Ornstein-Uhlenbeck (OU) process. The latter is a damped random walk capable of modelling trends in the data as well as smaller irregularities. It adds two parameters to the model: a length scale $\tau$ describing the interval within which correlations are important, and an amplitude $A_{\mathrm{OU}}$ describing the variance of the induced fluctuations. 
We regard these parameters as nuisance parameters, which will be sampled along with the remaining parameters of the model 

 


\subsection{Assumptions}

\subsubsection{Priors}

Here we list all the priors in the model.


\begin{table*}[hbtp]
\renewcommand{\arraystretch}{1.3}
\footnotesize
\caption{Model Parameters and Prior Probability Distributions}
%\resizebox{\textwidth}{!}{%
\begin{threeparttable} 
\begin{tabularx}{\textwidth}{p{4.0cm}p{7.0cm}X}%lrrrllll}%{lrrrllll}
%\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}} cll}%lrrrllll}%{lrrrllll}
%\begin{tabular}{|l|r|r|l|r|r|r|r|l|}
\toprule
\bf{Parameter} & \bf{Meaning} & \bf{Probability Distribution} \\ \midrule
\it{Hyperparameters} && \\ \midrule
$\mu_{\log{A}}$ & Mean of Laplacian prior distribution for line amplitude $\log{A}$ &   $\mathrm{truncated\, Cauchy\, distribution}(10^{-21}, 10^{21})$  \\
$\sigma_{\log{A}}$ & Standard deviation of Laplacian prior distribution for line amplitude $\log{A}$ & $\mathrm{Uniform}(0,2)$ \\
$\mu_{\log{q}}$ & Mean of Laplacian prior distribution for the $q$-factor $\log{q}$ & $\mathrm{Uniform}(\log{100}, \log{1000})$  \\
$\sigma_{\log{q}}$ & Standard deviation of the Laplacian prior distribution for the $q$-factor $\log{q}$ & $\mathrm{Uniform}(\log{0}, \log{0.3})$\\ 
\midrule
\it{Individual Spectral Line Parameters} && \\ \midrule
$\log{A_i}$ & logarithm of the amplitude of line $i$ & $\mathrm{Laplacian}(\mu_A \sigma_A)$ \\
$\log{q_i}$ & logarithm of $q_i = \lambda_{\mathrm{line}_{i}}/\sigma_{\mathrm{line}_{i}}$ & $\mathrm{Laplacian}(\mu_q, \sigma_q)$ \\
$\log{\counts}_{\mathrm{bkg}}$ & logarithm of the background flux & $\mathrm{truncated\, Cauchy\, distribution}(10^{-21}, 10^{21})$ \\
$d = v/c$ & Doppler shift $d$ parametrized as a function of velocity $v$ and speed of light $c$ & $\mathrm{Uniform}(-0.1, 0.1)$ \\
$N$ & Number of possible Doppler shifts & $\mathrm{Uniform}(0,5)$  \\\bottomrule
\end{tabularx}
   \begin{tablenotes}
      %\footnotesize
      \item{An overview over the model parameters and hyperparameters with their respective prior probability distributions.}
     %\item[\emph{a}]{See Section \ref{ch6:priortest} for a discussion on testing an alternative, log-normal prior for spike amplitude and exponential rise time scale.}
     %\item[\emph{a}]{$T_\mathrm{b}$: duration of total burst}
\end{tablenotes}
\end{threeparttable}
\label{tab:priortable}
%\tablecomments{An overview over the model parameters and hyperparameters with their respective prior probability distributions. For parameters where we have explored an alternative distribution in Section 
%\ref{ch6:priortest}, we give parameters and distributions for both priors.}
%\end{sidewaystable}
\end{table*}



\section{Simulated Data}

\subsection{Discussion on where assumptions fail}

Need to talk here about how the likelihood is multi-modal and sometimes the modes can be very narrow. 
This is a problem that makes all sampling algorithms fail, and requires careful tuning.


\section{Observations}

\section{Results}


\section{Discussions}



\paragraph{Acknowledgements}
DH was supported by the Moore-Sloan Data Science Environment at NYU.
BJB was supported by a Marsden Fast-Start grant from the Royal Society of
New Zealand.

\bibliography{td}
\bibliographystyle{apj}
\begin{thebibliography}{999}

\bibitem[Bolton et al.(2005)]{slacs0} Bolton, A.~S., Burles, 
S., Koopmans, L.~V.~E., Treu, T., 
\& Moustakas, L.~A.\ 2005, \apjl, 624, L21 

\bibitem[Bolton et al.(2006)]{slacs1} Bolton, A.~S., Burles, 
S., Koopmans, L.~V.~E., Treu, T., \& Moustakas, L.~A.\ 2006, \apj, 638, 703 

\end{thebibliography}

\end{document}


